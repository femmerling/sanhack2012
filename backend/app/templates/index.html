{% extends "base.html" %}
    {% block title %}Cablet{% endblock %}
    {% block sidebar %}
    <div style="overflow:auto; height:500px;">
    <table class="table table-hover" data-bind="foreach: toilets">
        <tr>
        <td>
            <img data-bind="attr:{src: '/static/img/'+((toilet_type==0)?'ladies_32.png':(toilet_type==1)?'gents_32.png':'ladies_gents_32.png')}" />
            <a data-bind="attr: {href: '/toilet/'+toilet_id}, text: toilet_name"></a>&nbsp;<span data-bind="text: distance"></span>m<br/>
            <ul class='star-rating'>
            <li class='current-rating' id='current-rating' data-bind="style: {width: '\''+Math.floor(toilet_current_rating*25)+'px\'' }" ></li>
            <li><a href="#" data-bind="attr: {onclick: 'vote('+toilet_id+',1,1); return false;'}" 
                   title='1 star out of 5' class='one-star'>1</a></li>
            <li><a href="#" data-bind="attr: {onclick: 'vote('+toilet_id+',1,2); return false;'}" 
                   title='2 star out of 5' class='two-stars'>2</a></li>
            <li><a href="#" data-bind="attr: {onclick: 'vote('+toilet_id+',1,3); return false;'}" 
                   title='3 star out of 5' class='three-stars'>3</a></li>
            <li><a href="#" data-bind="attr: {onclick: 'vote('+toilet_id+',1,4); return false;'}" 
                   title='4 star out of 5' class='four-stars'>4</a></li>
            <li><a href="#" data-bind="attr: {onclick: 'vote('+toilet_id+',1,5); return false;'}" 
                   title='5 star out of 5' class='five-stars'>5</a></li>
        </ul><span data-bind="text: '\''+Math.floor(toilet_current_rating*25)+'px;\''"></span>
            <span data-bind="text: toilet_address"></span><br/>
            <a href="#" class="btn" data-bind="attr: {onclick: 'getDirection('+toilet_lat+','+toilet_long+')'}">get direction</a>
        </td>
        </tr>
    </table>
    </div>
    {% endblock %}
    {% block content %}
    <div id="content">
    	<h1>Toilet Finder</h1>
        <meta name="viewport" content="width=620" />
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
        <article>
      <p>Finding your location: <span id="status">checking...</span></p>
    </article>
    </div>
  {% endblock %}
  {% block footer %}
  <div class="well">
      <p>Entry for Sanitation Hackathon 2012, Jakarta, Indonesia by <a target="_blank" href="http://twitter.com/femmerling">@femmerling</a> (Fauzan Emmerling), <a target="_blank" href="http://twitter.com/ksetyadi">@ksetyadi</a> (Kristiono Setyadi), and <a target="_blank" href="http://twitter.com/pebaryan">@pebaryan</a> (Peb Ruswono Aryan). </p>
       <footer>
      <p id="disclaimer">powered by <a target="_blank" href="https://github.com/femmerling/EmeraldBox/">EmeraldBox</a>, an open source python web framework by <a target="_blank" href="http://www.emfeld.com">Fauzan Emmerling</a>.</p>
      </footer>
      </div>
  {% endblock %}
  {% block addon %}
  <script type="text/javascript">
            var viewmodel = {
                toilets: ko.observableArray([])
            };
            
            ko.applyBindings(viewmodel);
            var lat=0.;
            var lon=0.;
            var directionDisplay;
            var directionsService = new google.maps.DirectionsService();
            var map;
            
            function success(position) {
            
                   directionsDisplay = new google.maps.DirectionsRenderer();
              var s = document.querySelector('#status');
              
              if (s.className == 'success') {
                // not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
                return;
              }
              
              lat = position.coords.latitude;
              lon = position.coords.longitude;
              
              s.innerHTML = "found you!";
              s.className = 'success';
              
              var mapcanvas = document.createElement('div');
              mapcanvas.id = 'mapcanvas';
              mapcanvas.style.height = '400px';
              mapcanvas.style.width = '560px';
                
              document.querySelector('article').appendChild(mapcanvas);
              
              var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
              var myOptions = {
                zoom: 15,
                center: latlng,
                mapTypeControl: false,
                navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
                mapTypeId: google.maps.MapTypeId.ROADMAP
              };
              map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);
              directionsDisplay.setMap(map);
              
              var marker = new google.maps.Marker({
                  position: latlng, 
                  map: map, 
                  title:"You are here! (at least within a "+position.coords.accuracy+" meter radius)"
              });
              
              $.getJSON('/search/'+position.coords.latitude+","+position.coords.longitude, function(data){
                    viewmodel.toilets(data.toilets)
              })
            }

            function error(msg) {
              var s = document.querySelector('#status');
              s.innerHTML = typeof msg == 'string' ? msg : "failed";
              s.className = 'fail';
              
              // console.log(arguments);
            }
            
            function getDirection(tlat,tlon){
                //alert(tlat+' '+tlon+' '+lat+' '+lon);
                var request = {
                    origin: new google.maps.LatLng(tlat, tlon),
                    destination: new google.maps.LatLng(lat, lon),
                    travelMode: google.maps.DirectionsTravelMode.WALKING
                };
                directionsService.route(request, function(response, status) {
                  if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                  }
                });
                $("#mapcanvas").focus(true)
            }
            
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(success, error);
            } else {
              error('not supported');
            }
            
            
        </script>
  {% endblock %}